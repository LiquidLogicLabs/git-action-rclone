name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g. v1.2.3)'
        required: true

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.event.inputs.tag || github.ref }}
  cancel-in-progress: false

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm run lint
      - run: npm run typecheck
      - run: npm test
      - run: npm run package
      - name: Verify dist/ is clean
        run: |
          if [ "$(git diff --name-only dist/)" != "" ]; then
            echo "::error::dist/ is out of date for this tag."
            exit 1
          fi

  e2e:
    name: E2E Tests
    needs: [validate]
    uses: ./.github/workflows/e2e-tests.yml

  release:
    name: Create Release
    needs: [validate, e2e]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag
        id: tag
        run: |
          TAG="${{ github.event.inputs.tag || github.ref_name }}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "major=$(echo $TAG | cut -d. -f1)" >> "$GITHUB_OUTPUT"

      - name: Update floating major tag
        run: |
          git tag -f ${{ steps.tag.outputs.major }} ${{ steps.tag.outputs.tag }}
          git push -f origin ${{ steps.tag.outputs.major }}

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ steps.tag.outputs.tag }} \
            --generate-notes \
            --title "${{ steps.tag.outputs.tag }}"

      - name: Job summary
        run: |
          echo "### Release ${{ steps.tag.outputs.tag }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Tag: \`${{ steps.tag.outputs.tag }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Floating tag: \`${{ steps.tag.outputs.major }}\`" >> "$GITHUB_STEP_SUMMARY"
